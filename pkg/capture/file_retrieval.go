// Copyright (c) 2021 Tigera, Inc. All rights reserved.

package capture

import (
	"bytes"
	"fmt"
	"io"

	"github.com/tigera/packetcapture-api/pkg/cache"
	v1 "k8s.io/api/core/v1"
	"k8s.io/client-go/kubernetes/scheme"
	"k8s.io/client-go/tools/remotecommand"
)

// FileRetrieval provides methods to access the files generated by a packet capture
type FileRetrieval interface {
	// OpenTarReader opens a tar reader for all the files that can be found at entryPoint on a cluster identified
	// by clusterID.
	OpenTarReader(clusterID string, entryPoint EntryPoint) (tarReader io.Reader, errorReader io.Reader, err error)
}

type fileRetrieval struct {
	cache cache.ClientCache
}

// NewFileRetrieval executes a remote command via the fluentd pods to retrieve the files
// generated by a packet capture
func NewFileRetrieval(clientCache cache.ClientCache) FileRetrieval {
	return &fileRetrieval{cache: clientCache}
}

func (f *fileRetrieval) OpenTarReader(clusterID string, entryPoint EntryPoint) (io.Reader, io.Reader, error) {
	var cs, config, err = f.cache.GetClientAndConfig(clusterID)
	if err != nil {
		return nil, nil, err
	}
	req := cs.CoreV1().RESTClient().Post().
		Resource("pods").
		Name(entryPoint.PodName).
		Namespace(entryPoint.PodNamespace).
		SubResource("exec")

	req.VersionedParams(
		&v1.PodExecOptions{
			Command: []string{
				"tar",
				"cf",
				"-",
				fmt.Sprintf("%s/%s/%s", entryPoint.CaptureDirectory, entryPoint.CaptureNamespace, entryPoint.CaptureName),
			},
			Stdin:  false,
			Stdout: true,
			Stderr: true,
			TTY:    false,
		},
		scheme.ParameterCodec,
	)
	var stderr bytes.Buffer
	var reader, writer = io.Pipe()
	exec, err := remotecommand.NewSPDYExecutor(config, "POST", req.URL())
	if err != nil {
		return nil, nil, err
	}

	go func() {
		defer writer.Close()
		err = exec.Stream(remotecommand.StreamOptions{
			Stdin:  nil,
			Stdout: writer,
			Stderr: &stderr,
		})
		if err != nil {
			stderr.Write([]byte(fmt.Sprintf("Remote command failed with error=%s", err.Error())))
		}
	}()

	return reader, &stderr, nil
}
