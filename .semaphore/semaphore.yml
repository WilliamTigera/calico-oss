version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Honeypod-controller
    task:
      jobs:
        - name: job
          commands:
            - chmod 0600 ~/.keys/*
            - ssh-add ~/.keys/*
            - 'git config --global --add url."git@github.com:".insteadOf "https://github.com/"'
            - checkout
            - sudo apt-get update || true
            - sudo apt-get -y --only-upgrade install google-cloud-sdk
            - 'export GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-$HOME/secrets/gcp-registry-pusher-service-account.json}'
            - 'gcloud auth activate-service-account --key-file="${GOOGLE_APPLICATION_CREDENTIALS}"'
            - gcloud auth configure-docker --quiet
            - make image run-elastic ut-no-cover tag-images push IMAGETAG=latest
      secrets:
        - name: marvin-github-ssh-private-key
        - name: gcp-registry-pusher-service-account
      env_vars: []
