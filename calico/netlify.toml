# Settings in the [build] context are global and are applied to all contexts unless otherwise overridden by more specific contexts.
[build]
  publish = "_site/"
  command = '''
  # LATEST_RELEASE is set in Netlify UI for environment-variables ONLY for docs.tigera.io site.
  # Any branch deployed there will have the production ready build that gets deployed at root /
  bundle install
  make bin/helm3
  export PATH=$PATH:$(pwd)/bin

  # LATEST_RELEASE is set in Netlify UI for environment-variables ONLY for docs.projectcalico.org and projectcalico.docs.tigera.io sites.
  # Any branch deployed there will have the production ready build that gets deployed at root /

  if [ -z "$LATEST_RELEASE" ]; then
    jekyll build --config _config.yml,$(pwd)/netlify/_config_noindex.yml --baseurl /$RELEASE_VERSION --destination _site/$RELEASE_VERSION
    mv _site/$RELEASE_VERSION/404.html _site/404.html
  else
    # build that gets deployed at root /
    jekyll build --config _config.yml,$(pwd)/netlify/_config_latest.yml
    
    mv _site/sitemap.xml _site/release-legacy-sitemap.xml
    mv _site/sitemap.xml _site/latest-sitemap.xml
    mv netlify/sitemap-index.xml _site/sitemap.xml
    mv netlify/_redirects _site/_redirects
    cp -r ../manifests _site/$RELEASE_VERSION
  fi
  '''

[build.environment]
  RUBY_VERSION = "2.6.2"
  RELEASE_VERSION = "master"

[context.deploy-preview]
  command = '''
  bundle install
  make bin/helm3
  export PATH=$PATH:$(pwd)/bin
  echo "url: $DEPLOY_PRIME_URL" > _config_url.yml
  jekyll build --config _config.yml,_config_url.yml
  cp -r ../manifests _site/$RELEASE_VERSION
  '''

[[redirects]]
  from = "/v3.13/*"
  to = "https://tigera-v3-13.netlify.app/v3.13/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.12/*"
  to = "https://tigera-v3-12.netlify.app/v3.12/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.11/*"
  to = "https://tigera-v3-11.netlify.app/v3.11/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.10/*"
  to = "https://tigera-v3-10.netlify.app/v3.10/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.9/*"
  to = "https://tigera-v3-9.netlify.app/v3.9/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.8/*"
  to = "https://tigera-v3-8.netlify.app/v3.8/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.7/*"
  to = "https://tigera-v3-7.netlify.app/v3.7/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.6/*"
  to = "https://tigera-v3-6.netlify.app/v3.6/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.5/*"
  to = "https://tigera-v3-5.netlify.app/v3.5/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.4/*"
  to = "https://tigera-v3-4.netlify.app/v3.4/:splat"
  status = 200
  headers = {X-From = "Netlify"} 
  
[[redirects]]
  from = "/v3.3/*"
  to = "https://tigera-v3-3.netlify.app/v3.3/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.2/*"
  to = "https://tigera-v3-2.netlify.app/v3.2/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.1/*"
  to = "https://tigera-v3-1.netlify.app/v3.1/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v3.0/*"
  to = "https://tigera-v3-0.netlify.app/v3.0/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v2.8/*"
  to = "https://tigera-v2-8.netlify.app/v2.8/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/v2.7/*"
  to = "https://tigera-v2-7.netlify.app/v2.7/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[redirects]]
  from = "/master/*"
  to = "https://tigera-master.netlify.app/master/:splat"
  status = 200
  headers = {X-From = "Netlify"}

# keeping this redirect incase anyone using old format
[[redirects]]
  from = "/download/archives/*"
  to = "https://downloads.tigera.io/ee/archives/:splat"
  status = 301
  headers = {X-From = "Netlify"}

# this redirect should be placed above the generic /download/charts/* redirect
[[redirects]]
  from = "/download/charts/master/*"
  to = "https://storage.googleapis.com/tigera-helm-charts/:splat"
  status = 200
  headers = {X-From = "Netlify"}

# keeping this redirect incase anyone using old format
[[redirects]]
  from = "/download/charts/*"
  to = "https://downloads.tigera.io/ee/charts/:splat"
  status = 301
  headers = {X-From = "Netlify"}

# this redirect should be placed above the generic /download/binaries/* redirect
[[redirects]]
  from = "/download/binaries/master/*"
  to = "https://storage.googleapis.com/tigera-binaries/:splat"
  status = 200
  headers = {X-From = "Netlify"}

# keeping this redirect incase anyone using old format
[[redirects]]
  from = "/download/binaries/*"
  to = "https://downloads.tigera.io/ee/binaries/:splat"
  status = 301
  headers = {X-From = "Netlify"}

# This redirect should be last in the order as, redirect rules are applied in order they are defined and this redirect
# takes care of all other versions (/*) apart from above specified versions.
[[redirects]]
  from = "/*"
  to = "https://tigera-legacy.netlify.app/:splat"
  status = 200
  headers = {X-From = "Netlify"}

[[headers]]
  for = "/*.yaml"
  [headers.values]
    content-type = "text/yaml"

[[headers]]
  for = "/*.yml"
  [headers.values]
    content-type = "text/yaml"

[[headers]]
  for = "/*.sh"
  [headers.values]
    content-type = "text/x-shellscript"

[[headers]]
  for = "/*.bash"
  [headers.values]
    content-type = "text/x-shellscript"
