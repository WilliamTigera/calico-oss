<ROOT>
  <source>
    @type monitor_agent
    bind "127.0.0.1"
    port 24220
  </source>
  <source>
    @type tail
    @id in_tail_flow_logs
    path "/var/log/calico/flowlogs/flows.log"
    pos_file "/var/log/calico/flows.log.pos"
    tag "flows"
    read_from_head true
    <parse>
      @type "json"
    </parse>
  </source>
  <source>
    @type tail
    path "/var/log/calico/audit/tsee-audit.log"
    pos_file "/var/log/calico/tsee-audit.log.pos"
    tag "audit.tsee"
    format json
    time_key time
    time_format %Y-%m-%dT%H:%M:%S.%N%z
    <parse>
      time_key time
      time_format %Y-%m-%dT%H:%M:%S.%N%z
      @type json
      time_type string
    </parse>
  </source>
  <source>
    @type tail
    path "/var/log/calico/audit/kube-audit.log"
    pos_file "/var/log/calico/kube-audit.log.pos"
    tag "audit.kube"
    format json
    time_key time
    time_format %Y-%m-%dT%H:%M:%S.%N%z
    <parse>
      time_key time
      time_format %Y-%m-%dT%H:%M:%S.%N%z
      @type json
      time_type string
    </parse>
  </source>
  <filter flows>
    @type record_transformer
    <record>
      host config.generator
    </record>
  </filter>
  <filter audit.*>
    @type record_transformer
    enable_ruby 
    <record>
      name ${record["responseObject"].nil? ? (record["objectRef"].nil? ? "-" : record["objectRef"]["name"]) :	(record["responseObject"]["metadata"].nil? ? record["responseObject"]["details"]["name"] : record["responseObject"]["metadata"]["name"])}
    </record>
  </filter>
  <match flows>
    @type elasticsearch
    host "elasticsearch-tigera-elasticsearch.calico-monitoring.svc.cluster.local"
    port 9200
    index_name "tigera_secure_ee_flows.test-cluster-name.%Y%m%d"
    template_file "/fluentd/etc/elastic_mapping_flows.template"
    template_name "tigera_secure_ee_flows"
    <buffer tag, time>
      timekey 1d
      flush_mode interval
      flush_interval 5s
    </buffer>
  </match>
  <match audit.tsee>
    @type elasticsearch
    host "elasticsearch-tigera-elasticsearch.calico-monitoring.svc.cluster.local"
    port 9200
    index_name "tigera_secure_ee_audit_ee.test-cluster-name.%Y%m%d"
    <buffer tag, time>
      timekey 1d
      flush_mode interval
      flush_interval 5s
    </buffer>
  </match>
  <match audit.kube>
    @type elasticsearch
    host "elasticsearch-tigera-elasticsearch.calico-monitoring.svc.cluster.local"
    port 9200
    index_name "tigera_secure_ee_audit_kube.test-cluster-name.%Y%m%d"
    <buffer tag, time>
      timekey 1d
      flush_mode interval
      flush_interval 5s
    </buffer>
  </match>
</ROOT>
