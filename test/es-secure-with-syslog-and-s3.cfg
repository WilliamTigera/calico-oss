<ROOT>
  <source>
    @type monitor_agent
    bind "127.0.0.1"
    port 24220
  </source>
  <source>
    @type tail
    @id in_tail_flow_logs
    path "/var/log/calico/flowlogs/flows.log"
    read_from_head true
    pos_file "/var/log/calico/flows.log.pos"
    tag "flows"
    emit_unmatched_lines false
    <parse>
      @type "json"
      unmatched_lines false
    </parse>
  </source>
  <source>
    @type tail
    @id in_tail_dns_logs
    path "/var/log/calico/dnslogs/dns.log"
    read_from_head true
    pos_file "/var/log/calico/dns.log.pos"
    tag "dns"
    emit_unmatched_lines false
    <parse>
      @type "json"
      unmatched_lines false
    </parse>
  </source>
  <source>
    @type tail
    @id in_tail_waf_logs
    path "/var/log/calico/waf/waf.log"
    pos_file "/var/log/calico/waf.log.pos"
    emit_unmatched_lines false
    read_from_head true
    tag "waf"
    <parse>
      @type "json"
      unmatched_lines false
    </parse>
  </source>
  <source>
    @type tail
    @id in_tail_l7_logs
    path "/var/log/calico/l7logs/l7.log"
    read_from_head true
    pos_file "/var/log/calico/l7.log.pos"
    tag "l7"
    emit_unmatched_lines false
    <parse>
      @type "json"
      unmatched_lines false
    </parse>
  </source>
  <source>
    @type tail
    @id in_tail_runtime_logs
    path "/var/log/calico/runtime-security/report.log"
    read_from_head true
    pos_file "/var/log/calico/report.log.pos"
    tag "runtime"
    emit_unmatched_lines false
    <parse>
      @type "json"
      unmatched_lines false
    </parse>
  </source>
  <source>
    @type tail
    path "/var/log/calico/audit/tsee-audit.log"
    read_from_head true
    pos_file "/var/log/calico/tsee-audit.log.pos"
    tag "audit.tsee"
    emit_unmatched_lines false
    format json
    time_key time
    time_format %Y-%m-%dT%H:%M:%S.%N%z
    <parse>
      time_key time
      time_format %Y-%m-%dT%H:%M:%S.%N%z
      @type json
      unmatched_lines false
      time_type string
    </parse>
  </source>
  <source>
    @type tail
    path "/var/log/calico/audit/kube-audit.log"
    pos_file "/var/log/calico/kube-audit.log.pos"
    tag "audit.kube"
    emit_unmatched_lines false
    format json
    time_key time
    time_format %Y-%m-%dT%H:%M:%S.%N%z
    <parse>
      time_key time
      time_format %Y-%m-%dT%H:%M:%S.%N%z
      @type json
      unmatched_lines false
      time_type string
    </parse>
  </source>
  <source>
    @type tail
    @id in_tail_compliance_report_logs
    path "/var/log/calico/compliance/compliance.*.reports.log"
    read_from_head true
    pos_file "/var/log/calico/compliance.reports.log.pos"
    tag "compliance.reports"
    emit_unmatched_lines false
    <parse>
      @type "json"
      unmatched_lines false
    </parse>
  </source>
  <source>
    @type tail
    @id in_tail_bird_logs
    path "/var/log/calico/bird/current"
    read_from_head true
    pos_file "/var/log/calico/bird.log.pos"
    tag "bird"
    emit_unmatched_lines false
    <parse>
      @type "regexp"
      expression /^(?<logtime>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})\.\d{5} bird: (?<message>.*)/
      unmatched_lines false
    </parse>
  </source>
  <source>
    @type tail
    @id in_tail_bird6_logs
    path "/var/log/calico/bird6/current"
    read_from_head true
    pos_file "/var/log/calico/bird6.log.pos"
    tag "bird6"
    emit_unmatched_lines false
    <parse>
      @type "regexp"
      expression /^(?<logtime>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})\.\d{5} bird: (?<message>.*)/
      unmatched_lines false
    </parse>
  </source>
  <source>
    @type tail
    @id in_tail_ids_event_logs
    path "/var/log/calico/ids/events.log"
    read_from_head true
    pos_file "/var/log/calico/ids.events.log.pos"
    tag "ids.events"
    emit_unmatched_lines false
    <parse>
      @type "json"
      time_key "time"
      keep_time_key true
      time_type unixtime
      unmatched_lines false
    </parse>
  </source>
  <source>
    @type prometheus
    bind "0.0.0.0"
    port 9081
    metrics_path "/metrics"
    <transport tls>
      cert_path "/tls/tls.crt"
      private_key_path "/tls/tls.key"
      ca_path "/etc/pki/tls/certs/tigera-ca-bundle.crt"
      client_cert_auth true
    </transport>
  </source>
  <source>
    @type prometheus_monitor
    <labels>
      hostname ${hostname}
    </labels>
  </source>
  <source>
    @type prometheus_output_monitor
    <labels>
      hostname ${hostname}
    </labels>
  </source>
  <source>
    @type prometheus_tail_monitor
    <labels>
      hostname ${hostname}
    </labels>
  </source>
  <filter flows>
    @type record_transformer
    enable_ruby
    <record>
      host test-node-name
    </record>
    <record>
      @timestamp ${record['end_time'] * 1000}
    </record>
  </filter>
  <filter dns>
    @type record_transformer
    <record>
      host test-node-name
    </record>
  </filter>
  <filter waf>
    @type record_transformer
    remove_keys level
    <record>
      host test-node-name
    </record>
  </filter>
  <filter l7>
    @type record_transformer
    <record>
      host test-node-name
    </record>
  </filter>
  <filter runtime>
    @type record_transformer
    <record>
      host test-node-name
    </record>
  </filter>
  <filter audit.*>
    @type record_transformer
    enable_ruby
    <record>
      name ${record["responseObject"].nil? ? (record["objectRef"].nil? ? "-" : record["objectRef"]["name"]) :	(record["responseObject"]["metadata"].nil? ? record["responseObject"]["details"]["name"] : record["responseObject"]["metadata"]["name"])}
    </record>
  </filter>
  <filter bird>
    @type record_transformer
    <record>
      host test-node-name
      ip_version IPv4
    </record>
  </filter>
  <filter bird6>
    @type record_transformer
    <record>
      host test-node-name
      ip_version IPv6
    </record>
  </filter>
  <filter bird bird6>
    @type grep
    <exclude>
      key "message"
      pattern /device1: Scanning interfaces/
    </exclude>
  </filter>
  <match ids.events>
    @type copy
    <store>
      @type "remote_syslog"
      host "169.254.254.254"
      port 3665
      packet_size 1024
      protocol tcp
      tls true
      verify_mode ${OPENSSL::SSL::VERIFY_NONE}
      severity "info"
      program "tigera_secure"
      hostname "nodename"
      <format>
        @type "json"
      </format>
      <buffer>
        flush_mode interval
        flush_interval 5s
      </buffer>
    </store>
  </match>
  <match flows>
    @type copy
    <store>
      @type "elasticsearch"
      host "elasticsearch-tigera-elasticsearch.calico-monitoring.svc.cluster.local"
      port 9200
      scheme https
      user "es-user"
      password xxxxxx
      ca_file "/etc/fluentd/elastic/ca.pem"
      ssl_verify true
      ssl_version TLSv1_2
      reload_connections false
      reload_on_failure false
      reconnect_on_error true
      index_name "tigera_secure_ee_flows.test-cluster-name."
      index_date_pattern "now/s{yyyyMMdd}"
      enable_ilm true
      ilm_policy_id "tigera_secure_ee_flows_policy"
      index_separator ""
      application_name "fluentd"
      template_file "/fluentd/etc/elastic_mapping_flows.template"
      template_name "tigera_secure_ee_flows"
      template_overwrite true
      <buffer tag, time>
        timekey 1d
        flush_mode interval
        flush_interval 5s
        flush_thread_count 4
      </buffer>
    </store>
    <store>
      @type "s3"
      aws_key_id xxxxxx
      aws_sec_key xxxxxx
      s3_bucket "dummy-bucket"
      s3_region "not-real-region"
      path "not-a-bucket/flows"
      <buffer>
        flush_mode interval
        flush_interval 30
      </buffer>
    </store>
    <store>
      @type "remote_syslog"
      host "169.254.254.254"
      port 3665
      packet_size 1024
      protocol tcp
      tls true
      verify_mode ${OPENSSL::SSL::VERIFY_NONE}
      severity "info"
      program "tigera_secure"
      hostname "nodename"
      <format>
        @type "json"
      </format>
      <buffer>
        flush_mode interval
        flush_interval 5s
      </buffer>
    </store>
  </match>
  <match dns>
    @type copy
    <store>
      @type "elasticsearch"
      host "elasticsearch-tigera-elasticsearch.calico-monitoring.svc.cluster.local"
      port 9200
      scheme https
      user "es-user"
      password xxxxxx
      ca_file "/etc/fluentd/elastic/ca.pem"
      ssl_verify true
      ssl_version TLSv1_2
      reload_connections false
      reload_on_failure false
      reconnect_on_error true
      index_name "tigera_secure_ee_dns.test-cluster-name."
      index_date_pattern "now/s{yyyyMMdd}"
      enable_ilm true
      ilm_policy_id "tigera_secure_ee_dns_policy"
      index_separator ""
      application_name "fluentd"
      template_file "/fluentd/etc/elastic_mapping_dns.template"
      template_name "tigera_secure_ee_dns"
      template_overwrite true
      <buffer tag, time>
        timekey 1d
        flush_mode interval
        flush_interval 5s
        flush_thread_count 4
      </buffer>
    </store>
    <store>
      @type "s3"
      aws_key_id xxxxxx
      aws_sec_key xxxxxx
      s3_bucket "dummy-bucket"
      s3_region "not-real-region"
      path "not-a-bucket/dns"
      <buffer>
        flush_mode interval
        flush_interval 30
      </buffer>
    </store>
  </match>
  <match waf>
    @type copy
    <store>
      @type "elasticsearch"
      host "elasticsearch-tigera-elasticsearch.calico-monitoring.svc.cluster.local"
      port 9200
      scheme https
      user "es-user"
      password xxxxxx
      ca_file "/etc/fluentd/elastic/ca.pem"
      ssl_verify true
      ssl_version TLSv1_2
      reload_connections false
      reload_on_failure false
      reconnect_on_error true
      index_name "tigera_secure_ee_waf.test-cluster-name."
      index_date_pattern "now/s{yyyyMMdd}"
      enable_ilm true
      ilm_policy_id "tigera_secure_ee_waf_policy"
      index_separator ""
      application_name "fluentd"
      template_file "/fluentd/etc/elastic_mapping_waf.template"
      template_name "tigera_secure_ee_waf"
      template_overwrite true
      <buffer tag, time>
        timekey 1d
        flush_mode interval
        flush_interval 5s
        flush_thread_count 4
      </buffer>
    </store>
  </match>
  <match l7>
    @type copy
    <store>
      @type "elasticsearch"
      host "elasticsearch-tigera-elasticsearch.calico-monitoring.svc.cluster.local"
      port 9200
      scheme https
      user "es-user"
      password xxxxxx
      ca_file "/etc/fluentd/elastic/ca.pem"
      ssl_verify true
      ssl_version TLSv1_2
      reload_connections false
      reload_on_failure false
      reconnect_on_error true
      index_name "tigera_secure_ee_l7.test-cluster-name."
      index_date_pattern "now/s{yyyyMMdd}"
      enable_ilm true
      ilm_policy_id "tigera_secure_ee_l7_policy"
      index_separator ""
      application_name "fluentd"
      template_file "/fluentd/etc/elastic_mapping_l7.template"
      template_name "tigera_secure_ee_l7"
      template_overwrite true
      <buffer tag, time>
        timekey 1d
        flush_mode interval
        flush_interval 5s
        flush_thread_count 4
      </buffer>
    </store>
    <store>
      @type "s3"
      aws_key_id xxxxxx
      aws_sec_key xxxxxx
      s3_bucket "dummy-bucket"
      s3_region "not-real-region"
      path "not-a-bucket/l7"
      <buffer>
        flush_mode interval
        flush_interval 30
      </buffer>
    </store>
  </match>
  <match audit.tsee>
    @type copy
    <store>
      @type "elasticsearch"
      host "elasticsearch-tigera-elasticsearch.calico-monitoring.svc.cluster.local"
      port 9200
      scheme https
      user "es-user"
      password xxxxxx
      ca_file "/etc/fluentd/elastic/ca.pem"
      ssl_verify true
      ssl_version TLSv1_2
      reload_connections false
      reload_on_failure false
      reconnect_on_error true
      index_name "tigera_secure_ee_audit_ee.test-cluster-name."
      index_date_pattern "now/s{yyyyMMdd}"
      enable_ilm true
      ilm_policy_id "tigera_secure_ee_audit_ee_policy"
      index_separator ""
      application_name "fluentd"
      template_file "/fluentd/etc/elastic_mapping_audits.template"
      template_name "tigera_secure_ee_audit"
      template_overwrite true
      <buffer tag, time>
        timekey 1d
        flush_mode interval
        flush_interval 5s
        flush_thread_count 4
      </buffer>
    </store>
    <store>
      @type "s3"
      aws_key_id xxxxxx
      aws_sec_key xxxxxx
      s3_bucket "dummy-bucket"
      s3_region "not-real-region"
      path "not-a-bucket/audit_tsee"
      <buffer>
        flush_mode interval
        flush_interval 30
      </buffer>
    </store>
  </match>
  <match audit.kube>
    @type copy
    <store>
      @type "elasticsearch"
      host "elasticsearch-tigera-elasticsearch.calico-monitoring.svc.cluster.local"
      port 9200
      scheme https
      user "es-user"
      password xxxxxx
      ca_file "/etc/fluentd/elastic/ca.pem"
      ssl_verify true
      ssl_version TLSv1_2
      reload_connections false
      reload_on_failure false
      reconnect_on_error true
      index_name "tigera_secure_ee_audit_kube.test-cluster-name."
      index_date_pattern "now/s{yyyyMMdd}"
      enable_ilm true
      ilm_policy_id "tigera_secure_ee_audit_kube_policy"
      index_separator ""
      application_name "fluentd"
      template_file "/fluentd/etc/elastic_mapping_audits.template"
      template_name "tigera_secure_ee_audit"
      template_overwrite true
      <buffer tag, time>
        timekey 1d
        flush_mode interval
        flush_interval 5s
        flush_thread_count 4
      </buffer>
    </store>
    <store>
      @type "s3"
      aws_key_id xxxxxx
      aws_sec_key xxxxxx
      s3_bucket "dummy-bucket"
      s3_region "not-real-region"
      path "not-a-bucket/audit_kube"
      <buffer>
        flush_mode interval
        flush_interval 30
      </buffer>
    </store>
    <store>
      @type "remote_syslog"
      host "169.254.254.254"
      port 3665
      packet_size 1024
      protocol tcp
      tls true
      verify_mode ${OPENSSL::SSL::VERIFY_NONE}
      severity "info"
      program "tigera_secure"
      hostname "nodename"
      <format>
        @type "json"
      </format>
      <buffer>
        flush_mode interval
        flush_interval 5s
      </buffer>
    </store>
  </match>
  <match bird bird6>
    @type copy
    <store>
      @type "elasticsearch"
      host "elasticsearch-tigera-elasticsearch.calico-monitoring.svc.cluster.local"
      port 9200
      scheme https
      user "es-user"
      password xxxxxx
      ca_file "/etc/fluentd/elastic/ca.pem"
      ssl_verify true
      ssl_version TLSv1_2
      reload_connections false
      reload_on_failure false
      reconnect_on_error true
      index_name "tigera_secure_ee_bgp.test-cluster-name."
      index_date_pattern "now/s{yyyyMMdd}"
      enable_ilm true
      ilm_policy_id "tigera_secure_ee_bgp_policy"
      index_separator ""
      application_name "fluentd"
      template_file "/fluentd/etc/elastic_mapping_bgp.template"
      template_name "tigera_secure_ee_bgp"
      template_overwrite true
      <buffer tag, time>
        timekey 1d
        flush_mode interval
        flush_interval 5s
        flush_thread_count 4
      </buffer>
    </store>
  </match>
  <match runtime>
    @type copy
    <store>
      @type "elasticsearch"
      host "elasticsearch-tigera-elasticsearch.calico-monitoring.svc.cluster.local"
      port 9200
      scheme https
      user "es-user"
      password xxxxxx
      ca_file "/etc/fluentd/elastic/ca.pem"
      ssl_verify true
      ssl_version TLSv1_2
      reload_connections false
      reload_on_failure false
      reconnect_on_error true
      index_name "tigera_secure_ee_runtime.test-cluster-name."
      index_date_pattern "now/s{yyyyMMdd}"
      enable_ilm true
      ilm_policy_id "tigera_secure_ee_runtime_policy"
      index_separator ""
      application_name "fluentd"
      template_file "/fluentd/etc/elastic_mapping_runtime.template"
      template_name "tigera_secure_ee_runtime"
      template_overwrite true
      <buffer tag, time>
        timekey 1d
        flush_mode interval
        flush_interval 5s
        flush_thread_count 4
      </buffer>
    </store>
    <store>
      @type "s3"
      aws_key_id xxxxxx
      aws_sec_key xxxxxx
      s3_bucket "dummy-bucket"
      s3_region "not-real-region"
      path "not-a-bucket/runtime"
      <buffer>
        flush_mode interval
        flush_interval 30
      </buffer>
    </store>
  </match>
  <match compliance.reports>
    @type copy
    <store>
      @type "s3"
      aws_key_id xxxxxx
      aws_sec_key xxxxxx
      s3_bucket "dummy-bucket"
      s3_region "not-real-region"
      path "not-a-bucket/compliance_reports"
      <buffer>
        flush_mode interval
        flush_interval 30
      </buffer>
    </store>
  </match>
</ROOT>
