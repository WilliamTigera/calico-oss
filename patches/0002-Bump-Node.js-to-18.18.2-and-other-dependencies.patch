From 0c16725e3d7b47d2edc99d98bef8c72c0a3c1c5a Mon Sep 17 00:00:00 2001
From: afra <122131693+ti-afra@users.noreply.github.com>
Date: Fri, 27 Oct 2023 11:19:46 -0700
Subject: [PATCH] Bump Node.js to 18.18.2 and other dependencies

1. Manually bumped Node.js to 18.18.2 by applying the commit [1] from
the upstream; with a difference that we do not switch to use kibana's
custom nodejs. We will never hit this issue mentioned in [2] in our
controlled containerized environment.

[1] https://github.com/elastic/kibana/commit/0a2c338f847b8cb52d5b8b869be081dc324bbc91
[2] https://www.elastic.co/blog/kibana-releases-nodejs-18

2. Bumped crypto-js to 4.2.0 to fix CVE-2023-46233
---
 .ci/Dockerfile                                   |  2 +-
 .node-version                                    |  2 +-
 .nvmrc                                           |  2 +-
 WORKSPACE.bazel                                  | 12 ++++++------
 package.json                                     |  8 ++++----
 packages/kbn-babel-register/src/cache.ts         |  2 +-
 packages/kbn-es-archiver/src/lib/progress.ts     |  2 +-
 packages/kbn-legacy-logging/src/log_format.ts    |  4 ++--
 .../server/kibana_monitoring/bulk_uploader.ts    |  2 +-
 yarn.lock                                        | 16 ++++++++--------
 10 files changed, 26 insertions(+), 26 deletions(-)

diff --git a/.ci/Dockerfile b/.ci/Dockerfile
index bf84d0a7..109b9ffa 100644
--- a/.ci/Dockerfile
+++ b/.ci/Dockerfile
@@ -1,7 +1,7 @@
 # NOTE: This Dockerfile is ONLY used to run certain tasks in CI. It is not used to run Kibana or as a distributable.
 # If you're looking for the Kibana Docker image distributable, please see: src/dev/build/tasks/os_packages/docker_generator/templates/dockerfile.template.ts
 
-ARG NODE_VERSION=18.17.1
+ARG NODE_VERSION=18.18.2
 
 FROM node:${NODE_VERSION} AS base
 
diff --git a/.node-version b/.node-version
index 4a1f488b..87ec8842 100644
--- a/.node-version
+++ b/.node-version
@@ -1 +1 @@
-18.17.1
+18.18.2
diff --git a/.nvmrc b/.nvmrc
index 4a1f488b..87ec8842 100644
--- a/.nvmrc
+++ b/.nvmrc
@@ -1 +1 @@
-18.17.1
+18.18.2
diff --git a/WORKSPACE.bazel b/WORKSPACE.bazel
index c7ecaa8a..d3966532 100644
--- a/WORKSPACE.bazel
+++ b/WORKSPACE.bazel
@@ -27,13 +27,13 @@ check_rules_nodejs_version(minimum_version_string = "3.8.0")
 # we can update that rule.
 node_repositories(
   node_repositories = {
-    "18.17.1-darwin_amd64": ("node-v18.17.1-darwin-x64.tar.gz", "node-v18.17.1-darwin-x64", "b3e083d2715f07ec3f00438401fb58faa1e0bdf3c7bde9f38b75ed17809d92fa"),
-    "18.17.1-darwin_arm64": ("node-v18.17.1-darwin-arm64.tar.gz", "node-v18.17.1-darwin-arm64", "18ca716ea57522b90473777cb9f878467f77fdf826d37beb15a0889fdd74533e"),
-    "18.17.1-linux_arm64": ("node-v18.17.1-linux-arm64.tar.xz", "node-v18.17.1-linux-arm64", "3f933716a468524acb68c2514d819b532131eb50399ee946954d4a511303e1bb"),
-    "18.17.1-linux_amd64": ("node-v18.17.1-linux-x64.tar.xz", "node-v18.17.1-linux-x64", "07e76408ddb0300a6f46fcc9abc61f841acde49b45020ec4e86bb9b25df4dced"),
-    "18.17.1-windows_amd64": ("node-v18.17.1-win-x64.zip", "node-v18.17.1-win-x64", "afc83f5cf6e8b45a4d3fb842904f604dcd271fefada31ad6654f8302f8da28c9"),
+    "18.18.2-darwin_amd64": ("node-v18.18.2-darwin-x64.tar.gz", "node-v18.18.2-darwin-x64", "5bb8da908ed590e256a69bf2862238c8a67bc4600119f2f7721ca18a7c810c0f"),
+    "18.18.2-darwin_arm64": ("node-v18.18.2-darwin-arm64.tar.gz", "node-v18.18.2-darwin-arm64", "9f982cc91b28778dd8638e4f94563b0c2a1da7aba62beb72bd427721035ab553"),
+    "18.18.2-linux_arm64": ("node-v18.18.2-linux-arm64.tar.xz", "node-v18.18.2-linux-arm64", "2e630e18548627f61eaf573233da7949dc0a1df5eef3f486fa9820c5f6c121aa"),
+    "18.18.2-linux_amd64": ("node-v18.18.2-linux-x64.tar.xz", "node-v18.18.2-linux-x64", "75aba25ae76999309fc6c598efe56ce53fbfc221381a44a840864276264ab8ac"),
+    "18.17.1-windows_amd64": ("node-v18.18.2-win-x64.zip", "node-v18.18.2-win-x64", "3bb0e51e579a41a22b3bf6cb2f3e79c03801aa17acbe0ca00fc555d1282e7acd"),
   },
-  node_version = "18.17.1",
+  node_version = "18.18.2",
   node_urls = [
     "https://nodejs.org/dist/v{version}/{filename}",
   ],
diff --git a/package.json b/package.json
index c9088b2f..cad2910d 100644
--- a/package.json
+++ b/package.json
@@ -66,7 +66,7 @@
     "url": "https://github.com/elastic/kibana.git"
   },
   "engines": {
-    "node": "18.17.1",
+    "node": "18.18.2",
     "yarn": "^1.21.1"
   },
   "resolutions": {
@@ -76,7 +76,7 @@
     "**/@babel/traverse": "^7.21.2",
     "**/@babel/types": "^7.21.2",
     "**/@types/babel__generator/@babel/types": "^7.21.0",
-    "**/@types/node": "18.17.5",
+    "**/@types/node": "18.18.5",
     "**/@types/react": "^16.14.25",
     "**/@types/react-dom": "^16.9.8",
     "**/@typescript-eslint/utils": "5.62.0",
@@ -86,7 +86,7 @@
     "**/html-minifier/uglify-js": "^3.14.3",
     "**/isomorphic-fetch/node-fetch": "^2.6.7",
     "**/json-schema": "^0.4.0",
-    "**/pdfkit/crypto-js": "4.0.0",
+    "**/pdfkit/crypto-js": "4.2.0",
     "**/react-syntax-highlighter": "^15.3.1",
     "**/recursive-readdir/minimatch": "^3.1.2",
     "**/remark-parse/trim": "1.0.1",
@@ -581,7 +581,7 @@
     "@types/mustache": "^0.8.31",
     "@types/ncp": "^2.0.1",
     "@types/nock": "^10.0.3",
-    "@types/node": "18.17.5",
+    "@types/node": "18.18.5",
     "@types/node-fetch": "2.6.4",
     "@types/node-forge": "^1.3.1",
     "@types/nodemailer": "^6.4.0",
diff --git a/packages/kbn-babel-register/src/cache.ts b/packages/kbn-babel-register/src/cache.ts
index 86ad7464..7b36d64a 100644
--- a/packages/kbn-babel-register/src/cache.ts
+++ b/packages/kbn-babel-register/src/cache.ts
@@ -29,7 +29,7 @@ export class Cache {
   private readonly pathRoot: string;
   private readonly prefix: string;
   private readonly log?: Writable;
-  private readonly timer: NodeJS.Timer;
+  private readonly timer: NodeJS.Timeout;
 
   constructor(config: { pathRoot: string; dir: string; prefix: string; log?: Writable }) {
     if (!Path.isAbsolute(config.pathRoot)) {
diff --git a/packages/kbn-es-archiver/src/lib/progress.ts b/packages/kbn-es-archiver/src/lib/progress.ts
index 5e54aba3..398f89d2 100644
--- a/packages/kbn-es-archiver/src/lib/progress.ts
+++ b/packages/kbn-es-archiver/src/lib/progress.ts
@@ -13,7 +13,7 @@ const SECOND = 1000;
 export class Progress {
   private total?: number;
   private complete?: number;
-  private loggingInterval?: NodeJS.Timer;
+  private loggingInterval?: NodeJS.Timeout;
 
   getTotal() {
     return this.total;
diff --git a/packages/kbn-legacy-logging/src/log_format.ts b/packages/kbn-legacy-logging/src/log_format.ts
index a0eaf023..13e421dd 100644
--- a/packages/kbn-legacy-logging/src/log_format.ts
+++ b/packages/kbn-legacy-logging/src/log_format.ts
@@ -56,7 +56,7 @@ export abstract class BaseLogFormat extends Stream.Transform {
 
   abstract format(data: Record<string, any>): string;
 
-  filter(data: Record<string, unknown>) {
+  filterData(data: Record<string, unknown>) {
     if (!this.config.filter) {
       return data;
     }
@@ -64,7 +64,7 @@ export abstract class BaseLogFormat extends Stream.Transform {
   }
 
   _transform(event: AnyEvent, enc: string, next: Stream.TransformCallback) {
-    const data = this.filter(this.readEvent(event));
+    const data = this.filterData(this.readEvent(event));
     this.push(this.format(data) + '\n');
     next();
   }
diff --git a/x-pack/plugins/monitoring/server/kibana_monitoring/bulk_uploader.ts b/x-pack/plugins/monitoring/server/kibana_monitoring/bulk_uploader.ts
index ea5b3671..9c1cfede 100644
--- a/x-pack/plugins/monitoring/server/kibana_monitoring/bulk_uploader.ts
+++ b/x-pack/plugins/monitoring/server/kibana_monitoring/bulk_uploader.ts
@@ -67,7 +67,7 @@ export class BulkUploader implements IBulkUploader {
   private kibanaStatusSubscription?: Subscription;
   private readonly opsMetrics$: Observable<OpsMetrics>;
   private kibanaStatus: ServiceStatusLevel | null;
-  private _timer: NodeJS.Timer | null;
+  private _timer: NodeJS.Timeout | null;
   private readonly _interval: number;
   private readonly config: MonitoringConfig;
   constructor({
diff --git a/yarn.lock b/yarn.lock
index c6b6361f..40ea021c 100644
--- a/yarn.lock
+++ b/yarn.lock
@@ -6335,10 +6335,10 @@
   dependencies:
     "@types/node" "*"
 
-"@types/node@*", "@types/node@18.17.5", "@types/node@>= 8", "@types/node@>=8.9.0", "@types/node@^10.1.0", "@types/node@^14.0.10 || ^16.0.0", "@types/node@^14.14.20 || ^16.0.0", "@types/node@^18.17.5":
-  version "18.17.5"
-  resolved "https://registry.yarnpkg.com/@types/node/-/node-18.17.5.tgz#c58b12bca8c2a437b38c15270615627e96dd0bc5"
-  integrity sha512-xNbS75FxH6P4UXTPUJp/zNPq6/xsfdJKussCWNOnz4aULWIRwMgP1LgaB5RiBnMX1DPCYenuqGZfnIAx5mbFLA==
+"@types/node@*", "@types/node@18.18.5", "@types/node@>= 8", "@types/node@>=8.9.0", "@types/node@^10.1.0", "@types/node@^14.0.10 || ^16.0.0", "@types/node@^14.14.20 || ^16.0.0", "@types/node@^18.17.5":
+  version "18.18.5"
+  resolved "https://registry.yarnpkg.com/@types/node/-/node-18.18.5.tgz#afc0fd975df946d6e1add5bbf98264225b212244"
+  integrity sha512-4slmbtwV59ZxitY4ixUZdy1uRLf9eSIvBWPQxNjhHYWEtn0FryfKpyS2cvADYXTayWdKEIsJengncrVvkI4I6A==
 
 "@types/nodemailer@^6.4.0":
   version "6.4.0"
@@ -10890,10 +10890,10 @@ crypto-browserify@^3.11.0:
     randombytes "^2.0.0"
     randomfill "^1.0.3"
 
-crypto-js@4.0.0, crypto-js@^3.1.9-1:
-  version "4.0.0"
-  resolved "https://registry.yarnpkg.com/crypto-js/-/crypto-js-4.0.0.tgz#2904ab2677a9d042856a2ea2ef80de92e4a36dcc"
-  integrity sha512-bzHZN8Pn+gS7DQA6n+iUmBfl0hO5DJq++QP3U6uTucDtk/0iGpXd/Gg7CGR0p8tJhofJyaKoWBuJI4eAO00BBg==
+crypto-js@4.2.0, crypto-js@^3.1.9-1:
+  version "4.2.0"
+  resolved "https://registry.yarnpkg.com/crypto-js/-/crypto-js-4.2.0.tgz#4d931639ecdfd12ff80e8186dba6af2c2e856631"
+  integrity sha512-KALDyEYgpY+Rlob/iriUtjV6d5Eq+Y191A5g4UqLAi8CyGP9N1+FdVbkc1SxKc2r4YAYqG8JzO2KGL+AizD70Q==
 
 crypto-random-string@^1.0.0:
   version "1.0.0"
-- 
2.34.1

