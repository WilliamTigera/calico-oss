From 80307e6611a4f76fec44d1b9ee4509540bd5ff12 Mon Sep 17 00:00:00 2001
From: Jiawei Huang <jiawei@tigera.io>
Date: Sat, 13 Jan 2024 18:16:07 -0800
Subject: [PATCH] Support UBI arm64 builds

---
 src/dev/build/tasks/os_packages/create_os_package_tasks.ts | 6 ++++++
 .../os_packages/docker_generator/templates/base/Dockerfile | 7 +++++++
 .../docker_generator/templates/build_docker_sh.template.ts | 6 +++---
 3 files changed, 16 insertions(+), 3 deletions(-)

diff --git a/src/dev/build/tasks/os_packages/create_os_package_tasks.ts b/src/dev/build/tasks/os_packages/create_os_package_tasks.ts
index 6ad51d7981e..15d99209077 100644
--- a/src/dev/build/tasks/os_packages/create_os_package_tasks.ts
+++ b/src/dev/build/tasks/os_packages/create_os_package_tasks.ts
@@ -81,6 +81,12 @@ export const CreateDockerUBI: Task = {
       ubi: true,
       image: true,
     });
+    await runDockerGenerator(config, log, build, {
+      architecture: 'aarch64',
+      context: false,
+      ubi: true,
+      image: true,
+    });
   },
 };
 
diff --git a/src/dev/build/tasks/os_packages/docker_generator/templates/base/Dockerfile b/src/dev/build/tasks/os_packages/docker_generator/templates/base/Dockerfile
index 17102eb2643..ce9195d77e8 100644
--- a/src/dev/build/tasks/os_packages/docker_generator/templates/base/Dockerfile
+++ b/src/dev/build/tasks/os_packages/docker_generator/templates/base/Dockerfile
@@ -9,8 +9,12 @@
 # Build stage 0 `builder`:
 # Extract Kibana artifact
 ################################################################################
+FROM calico/qemu-user-static as qemu
+
 FROM {{{baseOSImage}}} AS builder
 
+COPY --from=qemu /usr/bin/qemu-*-static /usr/bin/
+
 {{#ubi}}
 RUN {{packageManager}} install -y findutils tar gzip
 {{/ubi}}
@@ -55,6 +59,9 @@ RUN mkdir -p /opt/filebeat /opt/metricbeat && \
 # Add entrypoint
 ################################################################################
 FROM {{{baseOSImage}}}
+
+COPY --from=qemu /usr/bin/qemu-*-static /usr/bin/
+
 EXPOSE 5601
 
 {{#ubi}}
diff --git a/src/dev/build/tasks/os_packages/docker_generator/templates/build_docker_sh.template.ts b/src/dev/build/tasks/os_packages/docker_generator/templates/build_docker_sh.template.ts
index 73159cee1f0..0c38baf7322 100644
--- a/src/dev/build/tasks/os_packages/docker_generator/templates/build_docker_sh.template.ts
+++ b/src/dev/build/tasks/os_packages/docker_generator/templates/build_docker_sh.template.ts
@@ -19,10 +19,10 @@ function generator({
   baseOSImage,
   architecture,
 }: TemplateContext) {
-  const dockerArchitecture = architecture === 'aarch64' ? 'linux/arm64' : 'linux/amd64';
-  const dockerTargetName = `${imageTag}${imageFlavor}:${version}`;
+  const dockerArchitecture = architecture === 'aarch64' ? 'arm64' : 'amd64';
+  const dockerTargetName = `${imageTag}${imageFlavor}:${version}-${dockerArchitecture}`;
   const dockerBuild = dockerCrossCompile
-    ? `docker buildx build --platform ${dockerArchitecture} -t ${dockerTargetName} -f Dockerfile . || exit 1;`
+    ? `docker buildx build --platform linux/${dockerArchitecture} -t ${dockerTargetName} -f Dockerfile . || exit 1;`
     : `docker build -t ${dockerTargetName} -f Dockerfile . || exit 1;`;
   return dedent(`
   #!/usr/bin/env bash
-- 
2.43.0

