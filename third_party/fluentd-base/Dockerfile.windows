# Copyright (c) 2024 Tigera, Inc. All rights reserved.

ARG FLUENTD_UPSTREAM_VERSION

FROM fluent/fluentd:${FLUENTD_UPSTREAM_VERSION}

USER ContainerAdministrator

# The ROOT_DIR is set for Windows only.
ENV ROOT_DIR=c:

# - Add symlink to ruby install path.
#   - The ruby version gets updated occasionally so using a symlink
#     keeps us from needing to update the fluentd probes in the operator.
# - Install Calico Enterprise dependencies
RUN mklink /D c:\ruby c:\ruby31 && \
        setx /m path "c:\ruby\bin;%path%;" && \
        gem install elasticsearch-api:7.17.10 && \
        gem install elasticsearch-transport -v 7.17.10 && \
        gem install elasticsearch-xpack -v 7.17.10 && \
        gem install elasticsearch -v 7.17.10 && \
        gem install fluent-plugin-cloudwatch-logs -v 0.14.3 && \
        gem install fluent-plugin-elasticsearch -v 5.4.3 && \
        gem install fluent-plugin-prometheus -v 2.1.0 && \
        gem install fluent-plugin-remote_syslog -v 1.1.0 && \
        gem install fluent-plugin-s3 -v 1.7.2 && \
        gem install fluent-plugin-splunk-hec -v 1.3.3 && \
        gem install fluent-plugin-sumologic_output -v 1.8.0 && \
        gem sources --clear-all

RUN powershell -command "mkdir $env:ROOT_DIR\fluentd\etc" && \
        powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_bgp" && \
        powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_compliance_reports" && \
        powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_dns" && \
        powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_flows" && \
        powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_ids_events" && \
        powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_kube_audit" && \
        powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_l7" && \
        powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_runtime" && \
        powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_tsee_audit" && \
        powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_waf" && \
        powershell -command "mkdir $env:ROOT_DIR\fluentd\plugins"

RUN c:\ruby\msys64\usr\bin\bash.exe -lc "curl -L -o /usr/bin/jq.exe https://github.com/stedolan/jq/releases/download/jq-1.7.1/jq-win64.exe"

COPY rubyplugin/out_http.rb /fluentd/plugins/out_http.rb

# We are currently doing this because fluentd executed the http plugin from the standard library
# instead the linseed plugin defined in rubyplugin folder
# Upgrading to a newer ruby or fluentd will require a change to the commands below
RUN powershell -command "copy c:\fluentd\plugins\out_http.rb c:\ruby31\lib\ruby\gems\3.1.0\gems\fluentd-1.16.3-x64-mingw-ucrt\lib\fluent\plugin\out_http.rb" && \
        powershell -command "copy c:\fluentd\plugins\out_http.rb c:\ruby\lib\ruby\gems\3.1.0\gems\fluentd-1.16.3-x64-mingw-ucrt\lib\fluent\plugin\out_http.rb"
