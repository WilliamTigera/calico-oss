From 04bc1332533621283701cc2ce6bb49c6ae2e5fb1 Mon Sep 17 00:00:00 2001
From: rene-dekker <rene@tigera.io>
Date: Tue, 27 Feb 2024 14:34:56 -0800
Subject: [PATCH] Support UBI arm64 builds

---
 .../build/tasks/os_packages/create_os_package_tasks.ts    | 6 ++++++
 src/dev/build/tasks/os_packages/docker_generator/run.ts   | 2 +-
 .../docker_generator/templates/base/Dockerfile            | 7 +++++++
 .../templates/build_docker_sh.template.ts                 | 8 ++++----
 4 files changed, 18 insertions(+), 5 deletions(-)

diff --git a/src/dev/build/tasks/os_packages/create_os_package_tasks.ts b/src/dev/build/tasks/os_packages/create_os_package_tasks.ts
index 8230f6e41b7..10064b7fe36 100644
--- a/src/dev/build/tasks/os_packages/create_os_package_tasks.ts
+++ b/src/dev/build/tasks/os_packages/create_os_package_tasks.ts
@@ -75,6 +75,12 @@ export const CreateDockerUBI: Task = {
   description: 'Creating Docker UBI image',

   async run(config, log, build) {
+    await runDockerGenerator(config, log, build, {
+      architecture: 'aarch64',
+      context: false,
+      ubi: true,
+      image: true,
+    });
     await runDockerGenerator(config, log, build, {
       architecture: 'x64',
       context: false,
diff --git a/src/dev/build/tasks/os_packages/docker_generator/run.ts b/src/dev/build/tasks/os_packages/docker_generator/run.ts
index 5361110ef48..2263c19068c 100644
--- a/src/dev/build/tasks/os_packages/docker_generator/run.ts
+++ b/src/dev/build/tasks/os_packages/docker_generator/run.ts
@@ -39,7 +39,7 @@ export async function runDockerGenerator(
 ) {
   let baseOSImage = '';
   if (flags.ubuntu) baseOSImage = 'ubuntu:20.04';
-  if (flags.ubi) baseOSImage = 'docker.elastic.co/ubi9/ubi-minimal:latest';
+  if (flags.ubi) baseOSImage = 'docker.elastic.co/ubi8/ubi-minimal:latest';

   let imageFlavor = '';
   if (flags.ubi) imageFlavor += '-ubi';
diff --git a/src/dev/build/tasks/os_packages/docker_generator/templates/base/Dockerfile b/src/dev/build/tasks/os_packages/docker_generator/templates/base/Dockerfile
index 17102eb2643..ce9195d77e8 100644
--- a/src/dev/build/tasks/os_packages/docker_generator/templates/base/Dockerfile
+++ b/src/dev/build/tasks/os_packages/docker_generator/templates/base/Dockerfile
@@ -9,8 +9,12 @@
 # Build stage 0 `builder`:
 # Extract Kibana artifact
 ################################################################################
+FROM calico/qemu-user-static as qemu
+
 FROM {{{baseOSImage}}} AS builder

+COPY --from=qemu /usr/bin/qemu-*-static /usr/bin/
+
 {{#ubi}}
 RUN {{packageManager}} install -y findutils tar gzip
 {{/ubi}}
@@ -55,6 +59,9 @@ RUN mkdir -p /opt/filebeat /opt/metricbeat && \
 # Add entrypoint
 ################################################################################
 FROM {{{baseOSImage}}}
+
+COPY --from=qemu /usr/bin/qemu-*-static /usr/bin/
+
 EXPOSE 5601

 {{#ubi}}
diff --git a/src/dev/build/tasks/os_packages/docker_generator/templates/build_docker_sh.template.ts b/src/dev/build/tasks/os_packages/docker_generator/templates/build_docker_sh.template.ts
index 73159cee1f0..2daef0f7451 100644
--- a/src/dev/build/tasks/os_packages/docker_generator/templates/build_docker_sh.template.ts
+++ b/src/dev/build/tasks/os_packages/docker_generator/templates/build_docker_sh.template.ts
@@ -19,10 +19,10 @@ function generator({
   baseOSImage,
   architecture,
 }: TemplateContext) {
-  const dockerArchitecture = architecture === 'aarch64' ? 'linux/arm64' : 'linux/amd64';
-  const dockerTargetName = `${imageTag}${imageFlavor}:${version}`;
+  const dockerArchitecture = architecture === 'aarch64' ? 'arm64' : 'amd64';
+  const dockerTargetName = `${imageTag}${imageFlavor}:${version}-${dockerArchitecture}`;
   const dockerBuild = dockerCrossCompile
-    ? `docker buildx build --platform ${dockerArchitecture} -t ${dockerTargetName} -f Dockerfile . || exit 1;`
+    ? `docker buildx build --platform linux/${dockerArchitecture} -t ${dockerTargetName} -f Dockerfile . || exit 1;`
     : `docker build -t ${dockerTargetName} -f Dockerfile . || exit 1;`;
   return dedent(`
   #!/usr/bin/env bash
@@ -62,7 +62,7 @@ function generator({
   echo "Building: kibana${imageFlavor}-docker"; \\
   ${dockerBuild}

-  docker save ${imageTag}${imageFlavor}:${version} | gzip -c > ${dockerTargetFilename}
+  docker save ${imageTag}${imageFlavor}:${version}-${dockerArchitecture} | gzip -c > ${dockerTargetFilename}

   exit 0
   `);
--
2.34.1
