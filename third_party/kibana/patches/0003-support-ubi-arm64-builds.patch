From 8ec0ba271aa3334a6697d6530c77c84cfe83478a Mon Sep 17 00:00:00 2001
From: Vara <vara@tigera.io>
Date: Tue, 5 Nov 2024 22:13:47 -0800
Subject: [PATCH] support ubi arm64 builds

---
 src/dev/build/tasks/os_packages/create_os_package_tasks.ts | 6 ++++++
 .../os_packages/docker_generator/templates/base/Dockerfile | 7 +++++++
 .../docker_generator/templates/build_docker_sh.template.ts | 6 +++---
 3 files changed, 16 insertions(+), 3 deletions(-)

diff --git a/src/dev/build/tasks/os_packages/create_os_package_tasks.ts b/src/dev/build/tasks/os_packages/create_os_package_tasks.ts
index f422d9fae..de2d3f951 100644
--- a/src/dev/build/tasks/os_packages/create_os_package_tasks.ts
+++ b/src/dev/build/tasks/os_packages/create_os_package_tasks.ts
@@ -128,6 +128,12 @@ export const CreateDockerUBI: Task = {
   description: 'Creating Docker UBI image',
 
   async run(config, log, build) {
+    await runDockerGenerator(config, log, build, {
+      architecture: 'aarch64',
+      baseImage: 'ubi',
+      context: false,
+      image: true,
+    });
     await runDockerGenerator(config, log, build, {
       architecture: 'x64',
       baseImage: 'ubi',
diff --git a/src/dev/build/tasks/os_packages/docker_generator/templates/base/Dockerfile b/src/dev/build/tasks/os_packages/docker_generator/templates/base/Dockerfile
index ecb93cfd5..450ace611 100644
--- a/src/dev/build/tasks/os_packages/docker_generator/templates/base/Dockerfile
+++ b/src/dev/build/tasks/os_packages/docker_generator/templates/base/Dockerfile
@@ -9,8 +9,12 @@
 # Build stage 0 `builder`:
 # Extract Kibana artifact
 ################################################################################
+FROM calico/qemu-user-static as qemu
+
 FROM {{{baseImageName}}} AS builder
 
+COPY --from=qemu /usr/bin/qemu-*-static /usr/bin/
+
 {{#ubi}}
 RUN microdnf install -y findutils tar gzip
 {{/ubi}}
@@ -84,6 +88,9 @@ RUN mkdir -p /opt/filebeat /opt/metricbeat && \
 # Add entrypoint
 ################################################################################
 FROM {{{baseImageName}}}
+
+COPY --from=qemu /usr/bin/qemu-*-static /usr/bin/
+
 EXPOSE 5601
 
 {{#ubi}}
diff --git a/src/dev/build/tasks/os_packages/docker_generator/templates/build_docker_sh.template.ts b/src/dev/build/tasks/os_packages/docker_generator/templates/build_docker_sh.template.ts
index 2da3821ef..33cec08ed 100644
--- a/src/dev/build/tasks/os_packages/docker_generator/templates/build_docker_sh.template.ts
+++ b/src/dev/build/tasks/os_packages/docker_generator/templates/build_docker_sh.template.ts
@@ -24,10 +24,10 @@ function generator({
 }: TemplateContext) {
   const tag =
     (dockerTag ? dockerTag : version) + (dockerTagQualifier ? '-' + dockerTagQualifier : '');
-  const dockerTargetName = `${imageTag}${imageFlavor}:${tag}`;
-  const dockerArchitecture = architecture === 'aarch64' ? 'linux/arm64' : 'linux/amd64';
+  const dockerArchitecture = architecture === 'aarch64' ? 'arm64' : 'amd64';
+  const dockerTargetName = `${imageTag}${imageFlavor}:${tag}-${dockerArchitecture}`;
   const dockerBuild = dockerCrossCompile
-    ? `docker buildx build --platform ${dockerArchitecture} -t ${dockerTargetName} -f Dockerfile . || exit 1;`
+    ? `docker buildx build --platform linux/${dockerArchitecture} -t ${dockerTargetName} -f Dockerfile . || exit 1;`
     : `docker build -t ${dockerTargetName} -f Dockerfile . || exit 1;`;
   return dedent(`
   #!/usr/bin/env bash
-- 
2.25.1

