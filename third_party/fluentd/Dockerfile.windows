# Copyright (c) 2021-2022 Tigera, Inc. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

FROM quay.io/tigera/fluentd-base:v1.15.3-windows

USER ContainerAdministrator

# The ROOT_DIR is set for Windows only.
ENV ROOT_DIR=c:

# - Add symlink to ruby install path.
#   - The ruby version gets updated occasionally so using a symlink
#     keeps us from needing to update the fluentd probes in the operator.
# - Install required gems and other packages.
RUN mklink /D c:\ruby c:\ruby31 \
&& setx /m path "c:\ruby\bin;%path%;" \
&& gem install \
        bundler:2.4.7 \
        cgi:0.3.6 \
        elasticsearch-api:7.17.8 \
        elasticsearch-transport:7.17.8 \
        elasticsearch-xpack:7.17.8 \
        elasticsearch:7.17.8 \
        fluent-plugin-cloudwatch-logs:0.8.0 \
        fluent-plugin-elasticsearch:5.2.4 \
        fluent-plugin-prometheus:2.0.0 \
        fluent-plugin-s3:1.3.0 \
        fluent-plugin-splunk-hec:1.3.1 \
        fluent-plugin-sumologic_output:1.6.1 \
        # to reduce windows build effort, psych is pinned at v4.
        # bundled libyaml is removed in v5.0.0 (see https://github.com/ruby/psych/pull/541)
        psych:4.0.6 \
        rdoc:6.4.0 \
 && fluent-gem install fluent-plugin-remote_syslog:1.0.0 \
 && gem sources --clear-all \
 && powershell -command "mkdir $env:ROOT_DIR\fluentd\etc" \
 && powershell -command "mkdir $env:ROOT_DIR\fluentd\plugins" \
 && c:\ruby\msys64\usr\bin\bash.exe -lc "curl -L -o /usr/bin/jq.exe https://github.com/stedolan/jq/releases/download/jq-1.6/jq-win64.exe"

# On Windows, the destination format for COPY must use forward slashes.
COPY elastic_mapping_flows.template /fluentd/etc/elastic_mapping_flows.template
COPY elastic_mapping_dns.template /fluentd/etc/elastic_mapping_dns.template
COPY elastic_mapping_audits.template /fluentd/etc/elastic_mapping_audits.template
COPY elastic_mapping_bgp.template /fluentd/etc/elastic_mapping_bgp.template
COPY elastic_mapping_waf.template /fluentd/etc/elastic_mapping_waf.template
COPY elastic_mapping_l7.template /fluentd/etc/elastic_mapping_l7.template
COPY elastic_mapping_runtime.template /fluentd/etc/elastic_mapping_runtime.template

ENV FLOW_LOG_FILE=${ROOT_DIR}/TigeraCalico/flowlogs/flows.log
ENV POS_DIR=${ROOT_DIR}/TigeraCalico/flowlogs

# Use Windows-specific sources and transforms config - we only support flowlogs for now.
COPY fluent_sources.conf.windows /fluentd/etc/fluent_sources.conf
COPY fluent_transforms.conf.windows /fluentd/etc/fluent_transforms.conf

# Disable unsupported logs.
ENV DISABLE_ES_DNS_LOG=true
ENV DISABLE_ES_L7_LOG=true
ENV DISABLE_ES_BGP_LOG=true
ENV DISABLE_ES_RUNTIME_LOG=true

COPY output_match /fluentd/etc/output_match
COPY outputs /fluentd/etc/outputs
COPY inputs /fluentd/etc/inputs
COPY filters /fluentd/etc/filters
COPY rubyplugin /fluentd/plugins

# We are currently doing this because fluentd executed the http plugin from the standard library
# instead the linseed plugin defined in rubyplugin folder
# Upgrading to a newer ruby or fluentd will require a change to the commands below
RUN powershell -command "copy c:\fluentd\plugins\out_http.rb c:\ruby31\lib\ruby\gems\3.1.0\gems\fluentd-1.15.3-x64-mingw-ucrt\lib\fluent\plugin\out_http.rb"
RUN powershell -command "copy c:\fluentd\plugins\out_http.rb c:\ruby\lib\ruby\gems\3.1.0\gems\fluentd-1.15.3-x64-mingw-ucrt\lib\fluent\plugin\out_http.rb"


# Compliance reports logs needs a regex pattern because there will be
# multiple logs (one per report type), e.g. compliance.network-access.reports.log
ENV COMPLIANCE_LOG_FILE=${ROOT_DIR}/var/log/calico/compliance/compliance.*.reports.log
ENV DNS_LOG_FILE=${ROOT_DIR}/var/log/calico/dnslogs/dns.log
ENV BIRD_LOG_FILE=${ROOT_DIR}/var/log/calico/bird/current
ENV BIRD6_LOG_FILE=${ROOT_DIR}/var/log/calico/bird6/current
ENV IDS_EVENT_LOG_FILE=${ROOT_DIR}/var/log/calico/ids/events.log
ENV WAF_LOG_FILE=${ROOT_DIR}/var/log/calico/waf/waf.log
ENV L7_LOG_FILE=${ROOT_DIR}/var/log/calico/l7logs/l7.log
ENV EE_AUDIT_LOG_FILE=${ROOT_DIR}/var/log/calico/audit/tsee-audit.log
ENV RUNTIME_LOG_FILE=${ROOT_DIR}/var/log/calico/runtime-security/report.log

# TLS Settings
ENV TLS_KEY_PATH=${ROOT_DIR}/tls/tls.key
ENV TLS_CRT_PATH=${ROOT_DIR}/tls/tls.crt
ENV CA_CRT_PATH=${ROOT_DIR}/etc/pki/tigera/tigera-ca-bundle.crt

ENV ELASTIC_HOST=elasticsearch
ENV ELASTIC_PORT=9200
ENV ELASTIC_FLUSH_INTERVAL=5s

ENV KUBE_AUDIT_LOG=${ROOT_DIR}/var/log/calico/audit/kube-audit.log
ENV KUBE_AUDIT_POS=${POS_DIR}/kube-audit.log.pos

ENV ELASTIC_INDEX_SUFFIX=cluster

ENV S3_FLUSH_INTERVAL=5s
ENV S3_STORAGE=false

ENV ELASTIC_FLOWS_INDEX_SHARDS=1
ENV ELASTIC_FLOWS_INDEX_REPLICAS=0
ENV ELASTIC_DNS_INDEX_SHARDS=1
ENV ELASTIC_DNS_INDEX_REPLICAS=0
ENV ELASTIC_AUDIT_INDEX_REPLICAS=0
ENV ELASTIC_L7_INDEX_SHARDS=1
ENV ELASTIC_L7_INDEX_REPLICAS=0
ENV ELASTIC_WAF_INDEX_SHARDS=1
ENV ELASTIC_WAF_INDEX_REPLICAS=0
ENV ELASTIC_TEMPLATE_OVERWRITE=true
ENV ELASTIC_BGP_INDEX_SHARDS=1
ENV ELASTIC_BGP_INDEX_REPLICAS=0
ENV ELASTIC_RUNTIME_INDEX_SHARDS=1
ENV ELASTIC_RUNTIME_INDEX_REPLICAS=0

ENV SYSLOG_PACKET_SIZE=1024

# LINSEED DEFAULT PARAMS
ENV LINSEED_ENABLED=false
ENV LINSEED_ENDPOINT=ENDPOINT
ENV LINSEED_CA_PATH=/etc/flu/ca.pem
ENV LINSEED_CERT_PATH=/etc/flu/crt.pem
ENV LINSEED_KEY_PATH=/etc/flu/key.pem
ENV LINSEED_FLUSH_INTERVAL=5s
ENV LINSEED_TOKEN="${ROOT_DIR}/var/run/secrets/kubernetes.io/serviceaccount/token"


COPY readiness.sh /bin/
COPY liveness.sh /bin/
COPY syslog-environment.sh /bin/
COPY syslog-config.sh /bin/
COPY splunk-environment.sh /bin/
COPY splunk-config.sh /bin/
COPY sumo-environment.sh /bin/
COPY sumo-config.sh /bin/
COPY ee_entrypoint.sh /bin/
COPY eks/bin/eks-log-forwarder-startup.exe /bin/

RUN powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_flows" \
 && powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_dns" \
 && powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_tsee_audit" \
 && powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_kube_audit" \
 && powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_compliance_reports" \
 && powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_bgp" \
 && powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_ids_events" \
 && powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_l7" \
 && powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_runtime" \
 && powershell -command "mkdir $env:ROOT_DIR\fluentd\etc\output_waf"

EXPOSE 24284

ENTRYPOINT []
# The inner command run by bash.exe is the actual ruby path (c:/ruby31).
# Using the symlinked path (c:/ruby) fails at runtime:
# c:/ruby/bin/fluentd: Invalid argument @ rb_readlink - c:/ruby (Errno::EINVAL)
#
# Must use the "exec" form of CMD to work for both docker and containerd
# https://github.com/containerd/containerd/issues/5067
CMD ["c:/ruby/msys64/usr/bin/bash.exe", "-lc", "c:/bin/ee_entrypoint.sh c:/ruby31/bin/fluentd -c c:/fluentd/etc/fluent.conf"]
