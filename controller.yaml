apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: honeypod-controller
  namespace: tigera-intrusion-detection
spec:
  selector:
    matchLabels:
      app: honeypod-controller
  template:
    metadata:
      labels:
        app: honeypod-controller
    spec:
      serviceAccountName: honeypod-controller
      imagePullSecrets:
      - name: tigera-pull-secret
      containers:
      - name: controller 
        imagePullPolicy: "Always"
        image: gcr.io/tigera-security-research/honeypod-controller:latest-amd64
        env:
        - name: CLUSTER_NAME
          value: cluster
        - name: ELASTIC_INDEX_SUFFIX
          value: cluster
        - name: ELASTIC_SCHEME
          value: https
        - name: ELASTIC_HOST
          value: tigera-secure-es-http.tigera-elasticsearch.svc
        - name: ELASTIC_PORT
          value: "9200"
        - name: ELASTIC_ACCESS_MODE
          value: serviceuser
        - name: ELASTIC_SSL_VERIFY
          value: "true"
        - name: ELASTIC_USER
          valueFrom:
            secretKeyRef:
              key: username
              name: tigera-ee-intrusion-detection-elasticsearch-access
        - name: ELASTIC_USERNAME
          valueFrom:
            secretKeyRef:
              key: username
              name: tigera-ee-intrusion-detection-elasticsearch-access
        - name: ELASTIC_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: tigera-ee-intrusion-detection-elasticsearch-access
        - name: ELASTIC_CA
          value: /etc/ssl/elastic/ca.pem
        - name: ES_CA_CERT
          value: /etc/ssl/elastic/ca.pem
        - name: ES_CURATOR_BACKEND_CERT
          value: /etc/ssl/elastic/ca.pem
        - name: ELASTIC_REPLICAS
          value: "0"
        - name: ELASTIC_SHARDS
          value: "1"
        volumeMounts:
        - mountPath: /etc/ssl/elastic/
          name: elastic-ca-cert-volume
          #- mountPath: /var/run/secrets/kubernetes.io/serviceaccount
          #name: intrusion-detection-controller-token-csg8d
          #readOnly: true
        - mountPath: /pcap
          name: pcap
          readOnly: true
        - mountPath: /snort
          name: snort
      volumes:
      - name: elastic-ca-cert-volume
        secret:
          defaultMode: 420
          items:
          - key: tls.crt
            path: ca.pem
          secretName: tigera-secure-es-http-certs-public
          #- name: intrusion-detection-controller-token-csg8d
          #secret:
          #defaultMode: 420
          #secretName: intrusion-detection-controller-token-csg8d
      - name: pcap
        hostPath:
          path: /var/log/calico/pcap/
          type: Directory 
      - name: snort
        emptyDir: {}


