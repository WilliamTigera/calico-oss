{{- if .Values.certs.create }}
{{ $secretName :=  .Values.secret.name }}
{{ $namespace :=  .Release.Namespace }}
apiVersion: batch/v1
kind: Job
metadata:
    name: {{ include "cnx-voltron.name" . }}-voltron-certs
    labels:
        {{ include "cnx-voltron.labels" . | indent 4 }}
spec:
    activeDeadlineSeconds: {{ .Values.certs.activeDeadlineSeconds }}
    template:
        metadata:
            labels:
                {{ include "cnx-voltron.labels" . }}
        spec:
            serviceAccountName: {{ include "cnx-voltron.name" . }}
            restartPolicy: OnFailure
            containers:
                - name: generate-voltron-certs
                  image: "{{ .Values.certs.image }}:{{ .Values.certs.imageTag }}"
                  imagePullPolicy: {{ .Values.certs.imagePullPolicy }}
                  env:
                      - name: HOME
                        value: /tmp
                  workingDir: /tmp
                  command:
                      - /bin/bash
                      - -exc
                      - |
                        cat >> EOF > openssl.conf
                        [ req ]
                        default_bits		= 2048
                        default_keyfile 	= privkey.pem
                        distinguished_name	= req_distinguished_name
                        attributes		= req_attributes
                        x509_extensions	= v3_ca
                        string_mask = utf8only
                        promt = no

                        [ req_attributes ]
                        challengePassword		= A challenge password
                        challengePassword_min		= 4
                        challengePassword_max		= 20

                        [ req_distinguished_name ]
                        countryName		= US
                        stateOrProvinceName	= California
                        localityName	= San Francisco
                        0.organizationName	= Tigera, Inc
                        commonName=tigera-voltron
                        emailAddress    = contact@tigera.io

                        [ usr_cert ]
                        basicConstraints=CA:FALSE
                        nsComment			= "OpenSSL Generated Certificate"
                        subjectKeyIdentifier=hash
                        authorityKeyIdentifier=keyid,issuer

                        [ v3_req ]
                        basicConstraints = CA:TRUE
                        keyUsage = nonRepudiation, digitalSignature, keyEncipherment, keyCertSign

                        [ v3_ca ]
                        subjectAltName=DNS:voltron
                        subjectKeyIdentifier=hash
                        basicConstraints = critical,CA:true
                        keyUsage = nonRepudiation, digitalSignature, keyEncipherment, keyCertSign

                        [ proxy_cert_ext ]
                        basicConstraints=CA:FALSE
                        nsComment			= "OpenSSL Generated Certificate"
                        subjectKeyIdentifier=hash
                        authorityKeyIdentifier=keyid,issuer
                        proxyCertInfo=critical,language:id-ppl-anyLanguage,pathlen:3,policy:foo
                        EOF

                        mkdir -p voltron;
                        ssh-keygen -m PEM -b 2048 -t rsa -f voltron/voltron.key -N "";
                        openssl req -x509 -new -nodes -key voltron/voltron.key -sha256 -days 365 -out volton/voltron.crt -config openssl.conf;
                        kubectl create secret tls {{ $secretName }} --namespace {{ $namespace }} --cert=voltron.crt --key=voltron.key;
{{- end -}}
