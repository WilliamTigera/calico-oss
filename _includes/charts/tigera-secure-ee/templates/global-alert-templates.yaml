apiVersion: projectcalico.org/v3
kind: GlobalAlertTemplate
metadata:
  name: policy.pod
spec:
  description: "Alerts on any changes to pods within the cluster"
  summary: "[audit] [privileged access] change detected for pod ${objectRef.namespace}/${objectRef.name}"
  severity: 100
  period: 10m
  lookback: 10m
  dataSet: audit
  query: (verb=create OR verb=update OR verb=delete OR verb=patch) AND "objectRef.resource"=pods
  aggregateBy: [objectRef.name, objectRef.namespace]
  metric: count
  condition: gt
  threshold: 0

---

apiVersion: projectcalico.org/v3
kind: GlobalAlertTemplate
metadata:
  name: policy.globalnetworkpolicy
spec:
  description: "Alerts on any changes to network policies"
  summary: "[audit] [privileged access] change detected for ${objectRef.resource} ${objectRef.name}"
  severity: 100
  period: 10m
  lookback: 10m
  dataSet: audit
  query: '(verb=create OR verb=update OR verb=delete OR verb=patch) AND "objectRef.resource"=globalnetworkpolicies'
  aggregateBy: [objectRef.name, objectRef.resource]
  metric: count
  condition: gt
  threshold: 0

---

apiVersion: projectcalico.org/v3
kind: GlobalAlertTemplate
metadata:
  name: policy.globalnetworkset
spec:
  description: "Alerts on any changes to global network sets"
  summary: "[audit] [privileged access] change detected for ${objectRef.resource} ${objectRef.name}"
  severity: 100
  period: 10m
  lookback: 10m
  dataSet: audit
  query: (verb=create OR verb=update OR verb=delete OR verb=patch) AND "objectRef.resource"=globalnetworksets
  aggregateBy: [objectRef.resource, objectRef.name]
  metric: count
  condition: gt
  threshold: 0

---

apiVersion: projectcalico.org/v3
kind: GlobalAlertTemplate
metadata:
  name: policy.serviceaccount
spec:
  description: "Alerts on any changes to service accounts within the cluster"
  summary: "[audit] [privileged access] change detected for serviceaccount ${objectRef.namespace}/${objectRef.name}"
  severity: 100
  period: 10m
  lookback: 10m
  dataSet: audit
  query: (verb=create OR verb=update OR verb=delete OR verb=patch) AND "objectRef.resource"="serviceaccounts"
  aggregateBy: [objectRef.namespace, objectRef.name]
  metric: count
  condition: gt
  threshold: 0

---

apiVersion: projectcalico.org/v3
kind: GlobalAlertTemplate
metadata:
  name: network.cloudapi
spec:
  description: "Alerts on access to cloud metadata APIs"
  summary: "[flows] [cloud API] cloud metadata API accessed by ${source_namespace}/${source_name_aggr}"
  severity: 100
  period: 10m
  lookback: 10m
  dataSet: flows
  query: (dest_name_aggr='metadata-api' OR dest_ip='169.254.169.254' OR dest_name_aggr="kse.kubernetes" ) AND proto='tcp' AND action='allow' AND reporter=src AND (source_namespace='default')
  aggregateBy: [source_namespace, source_name_aggr]
  field: num_flows
  metric: sum
  condition: gt
  threshold: 0

---

apiVersion: projectcalico.org/v3
kind: GlobalAlertTemplate
metadata:
  name: network.ssh
spec:
  description: "Alerts on the use of ssh to and from a specific namespace (e.g. default)"
  summary: "[flows] ssh flow in default namespace detected from ${source_namespace}/${source_name_aggr}"
  severity: 100
  period: 10m
  lookback: 10m
  dataSet: flows
  query: proto='tcp' AND action='allow' AND dest_port='22' AND (source_namespace='default' OR dest_namespace='default') AND reporter=src
  aggregateBy: [source_namespace, source_name_aggr]
  field: num_flows
  metric: sum
  condition: gt
  threshold: 0

---

apiVersion: projectcalico.org/v3
kind: GlobalAlertTemplate
metadata:
  name: network.lateral.access
spec:
  description: "Alerts when pods with a specific label (e.g. app=monitor) accessed by other workloads within the cluster"
  summary: "[flows] [lateral movement] ${source_namespace}/${source_name_aggr} with label app=monitor is accessed"
  severity: 100
  period: 10m
  lookback: 10m
  dataSet: flows
  query: '"source_labels.labels"="app=monitor" AND proto=tcp AND action=allow AND reporter=dst'
  aggregateBy: [source_namespace, source_name_aggr]
  field: num_flows
  metric: sum
  condition: gt
  threshold: 0

---

apiVersion: projectcalico.org/v3
kind: GlobalAlertTemplate
metadata:
  name: network.lateral.originate
spec:
  description: "Alerts when pods with a specific label (e.g. app=monitor) initiate connections to other workloads within the cluster"
  summary: "[flows] [lateral movement] ${source_namespace}/${source_name_aggr} with label app=monitor initiated connection"
  severity: 100
  period: 10m
  lookback: 10m
  dataSet: flows
  query: '"source_labels.labels"="app=monitor" AND proto=tcp AND action=allow AND reporter=src AND NOT dest_name_aggr="metadata-api" AND NOT dest_name_aggr="pub" AND NOT dest_name_aggr="kse.kubernetes"'
  aggregateBy: [source_namespace, source_name_aggr]
  field: num_flows
  metric: sum
  condition: gt
  threshold: 0

