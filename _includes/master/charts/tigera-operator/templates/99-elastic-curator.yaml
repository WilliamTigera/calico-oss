# TODO: Install this via the tigera operator.
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: tigera-es-curator
  namespace: calico-monitoring
  labels:
    k8s-app: es-curator
spec:
  schedule: "@daily"
  jobTemplate:
    spec:
      template:
        metadata:
          name: tigera-es-curator
          namespace: calico-monitoring
          labels:
            k8s-app: es-curator
        spec:
          restartPolicy: OnFailure
          nodeSelector:
            beta.kubernetes.io/os: linux
          tolerations:
            - key: node-role.kubernetes.io/master
              effect: NoSchedule
          imagePullSecrets:
            - name: cnx-pull-secret
          containers:
            - name: tigera-es-curator
              image: quay.io/tigera/es-curator:v2.4.0
              env:
                - name: ELASTIC_INDEX_SUFFIX
                  valueFrom:
                    configMapKeyRef:
                      name: tigera-es-config
                      key: tigera.elasticsearch.cluster-name
                - name: EE_FLOWS_INDEX_RETENTION_PERIOD
                  valueFrom:
                    configMapKeyRef:
                      name: tigera-es-config
                      key: tigera.elasticsearch.flow-retention
                - name: EE_AUDIT_INDEX_RETENTION_PERIOD
                  valueFrom:
                    configMapKeyRef:
                      name: tigera-es-config
                      key: tigera.elasticsearch.audit-retention
                - name: EE_SNAPSHOT_INDEX_RETENTION_PERIOD
                  valueFrom:
                    configMapKeyRef:
                      name: tigera-es-config
                      key: tigera.elasticsearch.snapshot-retention
                - name: EE_COMPLIANCE_REPORT_INDEX_RETENTION_PERIOD
                  valueFrom:
                    configMapKeyRef:
                      name: tigera-es-config
                      key: tigera.elasticsearch.compliance-report-retention
                - name: ELASTIC_HOST
                  value: elasticsearch-tigera-elasticsearch.calico-monitoring.svc.cluster.local
                - name: ELASTIC_PORT
                  value: "9200"
                - name: ELASTIC_SSL_VERIFY
                  value: "false"
              volumeMounts:
                - name: elastic-ca-cert-volume
                  mountPath: /etc/curator/elastic
              livenessProbe:
                exec:
                  command:
                    - sh
                    - -c
                    - /usr/bin/curator --config /curator/curator_config.yaml --dry-run /curator/curator_action.yaml
                initialDelaySeconds: 60
                periodSeconds: 60
          volumes:
            # Should be created during installation process.
            - name: elastic-ca-cert-volume
              secret:
                optional: true
                items:
                - key: tigera.elasticsearch.ca
                  path: ca.pem
                secretName: tigera-es-config

