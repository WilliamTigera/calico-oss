apiVersion: v1
kind: Pod
metadata:
  generateName: run-reporter
  namespace: calico-monitoring
  labels:
    k8s-app: compliance-reporter
spec:
  serviceAccountName: tigera-compliance-reporter
  tolerations:
    - key: node-role.kubernetes.io/master
      effect: NoSchedule
{{- if .Values.imagePullSecrets }}
  imagePullSecrets:
{{- range $key, $value := .Values.imagePullSecrets }}
    - name: {{ $key }}
{{- end }}
{{- end }}
  containers:
  - name: reporter
    # Modify this image name, if you have re-tagged the image and are using a local
    # docker image repository.
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    image: {{.Values.complianceReporter.image}}:{{.Values.complianceReporter.tag}}
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
{{ tuple .Values.complianceReporter.resources | include "tigera-secure-ee.resourceLimits" | indent 4 -}}
    env:
      # Modify these values with the report name and start and end time of the report
      # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    - name: TIGERA_COMPLIANCE_REPORT_NAME
      value: <report name e.g. weekly-full-inventory>
    - name: TIGERA_COMPLIANCE_REPORT_START_TIME
      value: <report start time in UTC RFC3339 format, e.g.  2019-03-23T14:20:00Z>
    - name: TIGERA_COMPLIANCE_REPORT_END_TIME
      value: <report start time in UTC RFC3339 format, e.g. 2019-03-23T15:10:00Z>
      # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    - name: LOG_LEVEL
      value: "warning"
{{- if eq .Values.platform "gke" }}
    - name: HEALTH_PORT
      value: "9199"
{{- end }}
    - name: ELASTIC_INDEX_SUFFIX
      valueFrom:
        configMapKeyRef:
          name: tigera-es-config
          key: tigera.elasticsearch.cluster-name
    - name: ELASTIC_SCHEME
      valueFrom:
        configMapKeyRef:
          name: tigera-es-config
          key: tigera.elasticsearch.scheme
          optional: true
    - name: ELASTIC_HOST
      valueFrom:
        configMapKeyRef:
          name: tigera-es-config
          key: tigera.elasticsearch.host
    - name: ELASTIC_PORT
      valueFrom:
        configMapKeyRef:
          name: tigera-es-config
          key: tigera.elasticsearch.port
          optional: true
    - name: ELASTIC_USER
      valueFrom:
        secretKeyRef:
          name: elastic-compliance-user
          key: reporter.username
          optional: true
    - name: ELASTIC_PASSWORD
      valueFrom:
        secretKeyRef:
          name: elastic-compliance-user
          key: reporter.password
          optional: true
    - name: ELASTIC_SSL_VERIFY
      value: "true"
    - name: ELASTIC_CA
      valueFrom:
        configMapKeyRef:
          name: tigera-es-config
          key: tigera.elasticsearch.ca.path
          optional: true
{{- if .Values.complianceReporter.env }}
{{ toYaml .Values.complianceReporter.env | indent 6 }}
{{- end }}
    volumeMounts:
    - name: elastic-ca-cert-volume
      mountPath: /etc/ssl/elastic/
    livenessProbe:
      httpGet:
        path: /liveness
{{- if eq .Values.platform "gke" }}
        port: 9199
{{- else }}
        port: 9099
{{- end }}
        host: localhost
  volumes:
  - name: elastic-ca-cert-volume
    secret:
      optional: true
      items:
      - key: tigera.elasticsearch.ca
        path: ca.pem
      secretName: tigera-es-config
