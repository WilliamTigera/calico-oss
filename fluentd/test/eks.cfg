<ROOT>
  <source>
    @type cloudwatch_logs
    tag "audit.eks"
    log_group_name "/aws/eks/eks-audit-test/cluster/"
    use_log_stream_name_prefix true
    log_stream_name "kube-apiserver-audit-"
    state_file "/fluentd/cloudwatch-logs/elf-state"
    use_aws_timestamp true
    fetch_interval 10
  </source>
  <filter audit.eks>
    @type grep
    <regexp>
      key "level"
      pattern /RequestResponse/
    </regexp>
    <regexp>
      key "verb"
      pattern /^create$|^patch$|^update$|^delete$/
    </regexp>
  </filter>
  <filter audit.eks>
    @type record_transformer
    enable_ruby
    <record>
      name ${record["responseObject"].nil? ? (record["objectRef"].nil? ? "-" : record["objectRef"]["name"]) :	(record["responseObject"]["metadata"].nil? ? record["responseObject"]["details"]["name"] : record["responseObject"]["metadata"]["name"])}
      timestamp ${record["stageTimestamp"]}
    </record>
  </filter>
  <match audit.eks>
    @type copy
    <store>
      @type "elasticsearch"
      host "elasticsearch"
      port 9200
      ssl_version TLSv1_3
      reload_connections false
      reload_on_failure false
      reconnect_on_error true
      index_name "tigera_secure_ee_audit_kube.cluster."
      index_date_pattern "now/s{yyyyMMdd}"
      enable_ilm true
      ilm_policy_id "tigera_secure_ee_audit_kube_policy"
      index_separator ""
      application_name "fluentd"
      template_file "/fluentd/etc/elastic_mapping_audits.template"
      template_name "tigera_secure_ee_audit"
      template_overwrite true
      <buffer tag, time>
        timekey 1d
        flush_mode interval
        flush_interval 5s
        flush_thread_count 4
      </buffer>
    </store>
  </match>
</ROOT>
