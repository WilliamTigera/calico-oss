AWSTemplateFormatVersion: 2010-09-09
Description: Per-account Tigera resources
# Creates:
# - CloudTrail and required S3 bucket

Resources:
  TigeraS3:
    Type: "AWS::S3::Bucket"
    DeletionPolicy: Retain
    Properties:
      LifecycleConfiguration:
        Rules:
          -
            ExpirationInDays: 7
            Status: Enabled
  TigeraS3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref:  TigeraS3
      PolicyDocument:
        Statement:
          -
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:GetBucketAcl
            Resource: !GetAtt
              - TigeraS3
              - Arn
          -
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:PutObject
            Resource:
              Fn::Join:
                - ""
                -
                  - !GetAtt
                    - TigeraS3
                    - Arn
                  - "/*"
            Condition:
              StringEquals:
                "s3:x-amz-acl": "bucket-owner-full-control"
  TigeraTrail:
    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-events-rule.html
    Type: "AWS::CloudTrail::Trail"
    DependsOn:
      - TigeraS3
      - TigeraS3BucketPolicy
    Properties:
      TrailName: "tigera-cloudtrail"
      EnableLogFileValidation: true
      EventSelectors:
        - ReadWriteType: WriteOnly
      IncludeGlobalServiceEvents: true
      # Indicates whether the CloudTrail trail is currently logging AWS API calls.
      IsLogging: true
      IsMultiRegionTrail: true
      S3BucketName:
        Ref: TigeraS3

