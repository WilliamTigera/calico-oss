---
title: Policy Violation Monitoring & Reporting
---

Tigera Networking Essentials includes the feature to monitor violations to
policy configured in your cluster. By defining a set of simple query like
rules and thresholds, one can monitor and receive alerts for their Kubernetes
cluster for policy violations.

### Architecture

```

 +-----------------+
 | Host            |
 | +-----------------+     denied     +------------+     +------------+
 | | Host            |------------->--|            |     |            |--->--
 | | +-----------------+   packet     | Prometheus |     | Prometheus |        alert
 +-| | Host            |----------->--|   Server   |-->--|   Alert    |--->--
   | |   +----------+  |   metrics    |            |     |  Manager   |      mechanisms
   +-|   |  Felix   |-------------->--|            |     |            |--->--
     |   +----------+  |              +------------+     +------------+
     +-----------------+                    ^                   ^
                                            |                   |
                                web UI for accessing     web UI for accessing alert
                             metrics and configuring     states and configuring
                                 alert notifications     mechanisms to fan out to
```

Policy Violation & Reporting is accomplished using 3 key pieces:

1. Essentials specific `calico/node` image: An _Essentials_ specific Felix
   binary running inside `calico/node` monitors the host for Denied packets and
   collects metrics.
2. Prometheus Server(s) deployed as part of the _Essentials_ manifest scrapes
   every configured `calico/node` target. Alerting rules querying denied packet
   metrics are configured in Prometheus and when triggered, fire alerts to
   the Prometheus Alertmanager.
3. Prometheus Alertmanager (or simply Alertmanager) also deployed as part of
   the _Essentials_ manifest, receives alerts from Prometheus and forwards
   alerts to various alerting mechanisms such as _Pager Duty_, or _OpsGenie_.

### Metrics

The metrics generated are:

- `calico_denied_packets` - Total number of packets denied by Calico policies.
- `calico_denied_bytes` - Total number of bytes denied by Calico policies.

Using these metrics, one can identify the policy that denied packets as well as
the source IP Address of the packets that were denied by this policy. Using
Prometheus terminology, `calico_denied_packets` is the metric Name and `policy`
and `srcIP` are labels. Each one of these metrics will be available as a
combination of `{policy, srcIP}`. A HTTP GET request to retrieve metrics from a
`calico/node` container will provide output like this:

```
# HELP calico_denied_bytes Total number of bytes denied by calico policies.
# TYPE calico_denied_bytes gauge
calico_denied_bytes{policy="profile/k8s_ns.ns-0/0/deny",srcIP="10.245.13.133"} 300
calico_denied_bytes{policy="profile/k8s_ns.ns-0/0/deny",srcIP="10.245.13.149"} 840
# HELP calico_denied_packets Total number of packets denied by calico policies.
# TYPE calico_denied_packets gauge
calico_denied_packets{policy="profile/k8s_ns.ns-0/0/deny",srcIP="10.245.13.133"} 5
calico_denied_packets{policy="profile/k8s_ns.ns-0/0/deny",srcIP="10.245.13.149"} 14
```

This means that the profile `k8s_ns.ns-0` denied 5 packets (totaling 300 bytes)
originating from the IP Address "10.245.13.133" and the same profile denied 14
packets originating from the IP Address "10.245.13.149".

### Lifetime of a Metric

#### Node

Metrics with a `{policy, srcIP}` label pair will only be generated at a node
when there is packets directed at a _Endpoint_ are being actively denied by a
policy. Once generated they stay alive upto 60 seconds after the last packet
was dropped by a policy.

#### Prometheus

Once Prometheus scrapes a node and collects denied packet metrics, it will be
available at Prometheus until the a metric is considered _stale_, i.e.,
Prometheus has not seen any updates to this metric for some time. This time is
configurable and details on how to do this are available in the
[Prometheus Configuration]() document.

#### Metric Resets and Empty Responses

Denied Packet Metrics may not be generated by Felix in certain situations.
These situations apply for a pair of `{policy, srcIP}`

- If there are no packets being denied by a policy on a node, there will be no
  metrics generated by `Felix`.
- If there were metrics available but `Felix` has not observed any packets
  denied by a `{policy, srcIP}` pair in the last 60 seconds, then `Felix` will
  stop generating metrics for this pair.
