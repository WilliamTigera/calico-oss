
<match flows>
  @type copy
  <store>
    @type elasticsearch
    host "#{ENV['ELASTIC_HOST']}"
    port "#{ENV['ELASTIC_PORT']}"
    scheme "https"
    user "#{ENV['ELASTIC_USER']}"
    password "#{ENV['ELASTIC_PASSWORD']}"
    ca_file /etc/fluentd/elastic/ca.pem
    ssl_verify "#{ENV['ELASTIC_SSL_VERIFY']}"
    index_name "tigera_secure_ee_flows.#{ENV['ELASTIC_INDEX_SUFFIX']}.%Y%m%d"
    template_file /fluentd/etc/elastic_mapping_flows.template
    template_name tigera_secure_ee_flows
  <buffer tag, time>
    timekey 1d
    flush_mode interval
    flush_interval "#{ENV['ELASTIC_FLUSH_INTERVAL']}"
  </buffer>
  </store>
  <store>
    @type s3
    aws_key_id "#{ENV['AWS_KEY_ID']}"
    aws_sec_key "#{ENV['AWS_SEC_KEY']}"
    s3_bucket "#{ENV['S3_BUCKET_NAME']}"
    s3_region "#{ENV['AWS_REGION']}"
    path "#{ENV['S3_BUCKET_PATH']}/flows"
    <buffer>
      flush_mode interval
      flush_interval "#{ENV['S3_FLUSH_INTERVAL']}"
    </buffer>
  </store>
</match>

<match audit.tsee>
  @type copy
  <store>
    @type elasticsearch
    host "#{ENV['ELASTIC_HOST']}"
    port "#{ENV['ELASTIC_PORT']}"
    scheme "https"
    user "#{ENV['ELASTIC_USER']}"
    password "#{ENV['ELASTIC_PASSWORD']}"
    ca_file /etc/fluentd/elastic/ca.pem
    ssl_verify "#{ENV['ELASTIC_SSL_VERIFY']}"
    index_name "tigera_secure_ee_audit_ee.#{ENV['ELASTIC_INDEX_SUFFIX']}.%Y%m%d"
  <buffer tag, time>
    timekey 1d
    flush_mode interval
    flush_interval "#{ENV['ELASTIC_FLUSH_INTERVAL']}"
  </buffer>
  </store>
  <store>
    @type s3
    aws_key_id "#{ENV['AWS_KEY_ID']}"
    aws_sec_key "#{ENV['AWS_SEC_KEY']}"
    s3_bucket "#{ENV['S3_BUCKET_NAME']}"
    s3_region "#{ENV['AWS_REGION']}"
    path "#{ENV['S3_BUCKET_PATH']}/audit_tsee"
    <buffer>
      flush_mode interval
      flush_interval "#{ENV['S3_FLUSH_INTERVAL']}"
    </buffer>
  </store>
</match>

<match audit.kube>
  @type copy
  <store>
    @type elasticsearch
    host "#{ENV['ELASTIC_HOST']}"
    port "#{ENV['ELASTIC_PORT']}"
    scheme "https"
    user "#{ENV['ELASTIC_USER']}"
    password "#{ENV['ELASTIC_PASSWORD']}"
    ca_file /etc/fluentd/elastic/ca.pem
    ssl_verify "#{ENV['ELASTIC_SSL_VERIFY']}"
    index_name "tigera_secure_ee_audit_kube.#{ENV['ELASTIC_INDEX_SUFFIX']}.%Y%m%d"
  <buffer tag, time>
    timekey 1d
    flush_mode interval
    flush_interval "#{ENV['ELASTIC_FLUSH_INTERVAL']}"
  </buffer>
  </store>
  <store>
    @type s3
    aws_key_id "#{ENV['AWS_KEY_ID']}"
    aws_sec_key "#{ENV['AWS_SEC_KEY']}"
    s3_bucket "#{ENV['S3_BUCKET_NAME']}"
    s3_region "#{ENV['AWS_REGION']}"
    path "#{ENV['S3_BUCKET_PATH']}/audit_kube"
    <buffer>
      flush_mode interval
      flush_interval "#{ENV['S3_FLUSH_INTERVAL']}"
    </buffer>
  </store>
</match>
